<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Wanderlust</title>
  <link rel="icon" type="image/png" href="/image/logo1.png">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    body {
      overflow-x: hidden;
    }
    .logo{
      color: red !important;
    }
    .sidebar-link {
      color: white;
      padding: 10px 20px;
      display: block;
      text-decoration: none;
    }
    .sidebar-link:hover,
    .sidebar-link.active {
      background-color: #0d6efd;
      border-radius: 5px;
    }
    .card-img-top {
      height: 200px;
      object-fit: cover;
    }
    .navbar{
    min-height: 11vh;
    background-color: #ebebeb;
  }
    @media (max-width: 991px) {
    .mobile-large-text {
      font-size: 2rem; /* larger text only on small screens */
    }
  }
  

  </style>
  <%-include("../includes/flash.ejs") %>
</head>
<body>


    <nav class="navbar navbar-expand-lg navbar-light bg-light sticky-top shadow-sm">
    <div class="container-fluid">

      <!-- Toggle Button with Font Awesome icon -->
      <button class="btn btn-outline-secondary d-lg-none me-2" type="button" data-bs-toggle="offcanvas" data-bs-target="#offcanvasSidebar">
        <i class="fa-solid fa-bars fs-3"></i> <!-- Big icon -->
      </button>

      <!-- Logo (hidden on mobile) -->
      <a class="navbar-brand d-none d-lg-flex align-items-center" href="/listings">
        <i class=" logo fa-regular fa-compass fs-3 me-1 "></i>
        <a class="nav-link fw-bold text-dark px-2 px-lg-3 " href="/listings">Explore</a>
      </a>

      <!-- Explore and Logout links -->
      <div class="ms-auto d-flex align-items-center">
        <a class="nav-link fw-bold text-dark  px-2 px-lg-3 " href="/logout">Log Out</a>
      </div>

    </div>
  </nav>

  <div class="container-fluid">
    <div class="row">
      <!-- Sidebar -->
      <nav class="col-lg-2 d-none d-lg-block bg-dark sidebar text-white min-vh-100 position-fixed">
        <div class="pt-3">
          <h4 class="text-center">Wanderlust</h4>
          <a href="#home" class="sidebar-link active" data-target="home">
  <i class="fas fa-home me-2"></i> Home
</a>
<a href="#make-admin" class="sidebar-link" data-target="make-admin">
  <i class="fas fa-user-shield me-2"></i> Make Admin
</a>
<a href="#admins" class="sidebar-link" data-target="admins">
  <i class="fas fa-user-cog me-2"></i>View Admins
</a>



          <a href="#users" class="sidebar-link" data-target="users">
            <i class="fas fa-users me-2"></i> Users
          </a>
          <a href="#requests" class="sidebar-link" data-target="requests">
            <i class="fas fa-file-alt me-2"></i> Requests
          </a>
          <a href="#" class="sidebar-link" data-target="history">
  <i class="fas fa-history me-2"></i> History
</a>

          
        </div>
      </nav>

      <!-- Offcanvas Sidebar (for mobile) -->
<div class="offcanvas offcanvas-start text-bg-dark" tabindex="-1" id="offcanvasSidebar">
  <div class="offcanvas-header">
    <h5 class="offcanvas-title">Admin Menu</h5>
    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="offcanvas" aria-label="Close"></button>
  </div>
  <div class="offcanvas-body">
    <a href="#home" class="sidebar-link active" data-target="home">
  <i class="fas fa-home me-2"></i> Home
</a>
    <a href="#make-admin" class="sidebar-link" data-target="make-admin">
  <i class="fas fa-user-shield me-2"></i> Make Admin
</a>
<a href="#admins" class="sidebar-link" data-target="admins">
  <i class="fas fa-user-cog me-2"></i>View Admins
</a>


    <a href="#" class="sidebar-link" data-target="users"><i class="fas fa-users me-2"></i> Users</a>
    <a href="#" class="sidebar-link" data-target="requests"><i class="fas fa-file-alt me-2"></i> Requests</a>
    <a href="#" class="sidebar-link" data-target="history">
  <i class="fas fa-history me-2"></i> History
</a>


  </div>
</div>


      <!-- Main content -->
      <main class="col-lg-10 offset-lg-2 py-4 px-3">
      <div id="home" class="content-section">
  <h3><i>Welcome to Wandarlust</i></h3>
  <div class="row">

    <!-- Pending Requests -->
    <div class="col-md-4">
      <div class="card text-white bg-primary mb-3 shadow">
        <div class="card-body">
          <h5 class="card-title">Pending Requests</h5>
          <p class="card-text fs-4"><%= listings.length %></p>
        </div>
      </div>
    </div>

    <!-- Approved Properties -->
    <!-- Approved Properties -->


    <!-- Total Users -->
    <!-- Total Users -->
<div class="col-md-4">
  <div class="card text-white bg-info mb-3 shadow">
    <div class="card-body">
      <h5 class="card-title">Total Users</h5>
      <p class="card-text fs-4">
        <%= users.filter(u => !u.isAdmin && !u.isSuperAdmin).length %>
      </p>
    </div>
  </div>
</div>

<!-- Total Admins -->
<div class="col-md-4">
  <div class="card text-white bg-warning mb-3 shadow">
    <div class="card-body">
      <h5 class="card-title">Total Admins</h5>
      <p class="card-text fs-4">
        <%= users.filter(u => u.isAdmin && !u.isSuperAdmin).length %>
      </p>
    </div>
  </div>
</div>

<!-- Total Super Admins -->
<div class="col-md-4">
  <div class="card text-white bg-dark mb-3 shadow">
    <div class="card-body">
      <h5 class="card-title">Total Super Admins</h5>
      <p class="card-text fs-4">
        <%= users.filter(u => u.isSuperAdmin).length
 %>
      </p>
    </div>
  </div>
</div>


  </div>
</div>




<!-- Make Admin Tab -->
<!-- Admin Tab Content -->
<div id="make-admin" class="content-section d-none">
  <div class="container-fluid">
  <div class="row">
    <!-- Left spacing on desktop -->
    <div class="col-lg-3 d-none d-lg-block"></div>

    <!-- Form card -->
    <div class="col-12 col-lg-9 py-4">
  <h3 class="mb-4">Create New Admin</h3>
  <form action="/admin/create-new-admin" method="POST" class="needs-validation col-md-6" novalidate>
    
    <div class="mb-3">
      <label for="username" class="form-label">Username</label>
      <input type="text" name="username" class="form-control" required />
      <div class="invalid-feedback">Username is required</div>
    </div>

    <div class="mb-3">
      <label for="email" class="form-label">Email</label>
      <input type="email" name="email" class="form-control" required />
      <div class="invalid-feedback">Enter a valid email</div>
    </div>

    <div class="mb-3">
      <label for="mobile" class="form-label">Mobile</label>
      <input type="tel" name="mobile" class="form-control" pattern="[6-9]{1}[0-9]{9}" required title="10-digit Indian mobile number" />
      <div class="invalid-feedback">Enter a valid 10-digit mobile number</div>
    </div>

    <div class="mb-3">
      <label for="password" class="form-label">Set Admin Password</label>
      <input type="password" name="password" class="form-control" required />
      <div class="invalid-feedback">Password is required</div>
    </div>

    <button type="submit" class="btn btn-success">Create Admin</button>
  </form>
</div>
</div>
</div>
</div>


<!--  view Admins Tab -->
<div id="admins" class="content-section d-none">
  <h3>All Admins</h3>
  <% if (admins && admins.length === 0) { %>
    <div class="alert alert-info">No admins found.</div>
  <% } else { %>
    <table class="table table-bordered table-striped">
      <thead>
        <tr>
          <th>#</th>
          <th>Email</th>
          <th>Username</th>
          <th>Mobile</th>
          <th> Account Created</th>

        </tr>
      </thead>
      <tbody>
        <% admins.forEach((admin, index) => { %>
          <tr>
            <td><%= index + 1 %></td>
            <td><%= admin.email %></td>
            <td><%= admin.username %></td>
            <td><%= admin.mobile %></td>
            <td>
  <% if (admin.createdAt) { %>
    <%= admin.createdAt.toDateString() %>
  <% } else { %>
    N/A
  <% } %>
</td>

<% if (currentUser.isSuperAdmin && admin._id.toString() !== currentUser._id.toString()) { %>
  <td>
    <% if (admin.isBlocked) { %>
      <form method="POST" action="/admin/unblock/<%= admin._id %>">
        <button class="btn btn-success btn-sm">Unblock</button>
      </form>
    <% } else { %>
      <form method="POST" action="/admin/block/<%= admin._id %>">
        <button class="btn btn-danger btn-sm">Block</button>
      </form>
    <% } %>
  </td>
<% } %>


          </tr>
        <% }) %>
      </tbody>
    </table>
  <% } %>
</div>







        <!-- Users Tab -->
        <div id="users" class="content-section">
  <h3>Registered Users</h3>
  <% 
    const normalUsers = users.filter(u => !u.isAdmin); 
  %>
  <% if (normalUsers.length === 0) { %>
    <div class="alert alert-info">No users found.</div>
  <% } else { %>
    <table class="table table-bordered table-striped">
      <thead>
        <tr>
          <th>Username</th>
          <th>Email</th>
          <th>Phone</th>
          <th>Account Created</th>
          <th>Total Property</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody>
        <% normalUsers.forEach(user => { %>
          <tr>
            <td><%= user.username %></td>
            <td><%= user.email %></td>
            <td><%= user.mobile || 'N/A' %></td>
            <td><%= user.createdAt ? user.createdAt.toDateString() : 'N/A' %></td>
            <td><%= user.postCount %></td>
            <td>
              <% if (user.isBlocked) { %>
                <form method="POST" action="/admin/users/<%= user._id %>/unblock">
                  <button class="btn btn-warning btn-sm">Unblock</button>
                </form>
              <% } else { %>
                <form method="POST" action="/admin/users/<%= user._id %>/block">
                  <button class="btn btn-danger btn-sm">Block</button>
                </form>
              <% } %>
            </td>
          </tr>
        <% }); %>
      </tbody>
    </table>
  <% } %>
</div>


        <!-- Requests Tab -->
        <div id="requests" class="content-section d-none">
  <h3>Property Requests</h3>

  <% if (listings.length === 0) { %>
    <div class="alert alert-info">No unapproved Property</div>
  <% } else { %>
    <div class="row">
      <% listings.forEach((listing, index) => { %>
        <div class="col-md-4 mb-4">
          <div class="card shadow">
            <img src="<%= listing.image.url %>" class="card-img-top" style="height: 200px; object-fit: cover;">
            <div class="card-body">
              <h5 class="card-title"><%= listing.title %></h5>
              <p class="mb-1"><strong>Owner:</strong> <%= listing.owner.username %></p>
              <p class="mb-1"><strong>Email:</strong> <%= listing.owner.email %></p>
              <button class="btn btn-primary btn-sm mt-2" data-bs-toggle="collapse" data-bs-target="#details<%= index %>">View</button>
            </div>
            <div class="collapse px-3 pb-3" id="details<%= index %>">
              <hr>
              <p><strong>Description:</strong> <%= listing.description %></p>
              <p><strong>Location:</strong> <%= listing.location %></p>
              <p><strong>Price:</strong> ₹<%= listing.price %></p>
               <p><strong>Country:</strong> <%= listing.country %></p>
               <p><strong>Category:</strong> <%= listing.category %></p>
               <% if (listing.facilities && listing.facilities.length > 0) { %>
            <p><strong>Facilities:</strong></p>
            <ul>
              <% listing.facilities.forEach(facility => { %>
                <li><%= facility %></li>
              <% }); %>
            </ul>
          <% } else { %>
            <p>No facilities listed.</p>
          <% } %>
              <div class="d-flex gap-2">
                <form method="POST" action="/admin/listings/<%= listing._id %>/approve">
                  <button type="submit" class="btn btn-success btn-sm">Approve</button>
                </form>
                <!-- Reject Button triggers modal -->
                <button class="btn btn-danger btn-sm" data-bs-toggle="modal" data-bs-target="#rejectModal<%= index %>">Reject</button>
              </div>
            </div>
          </div>
        </div>
        <!-- Reject Modal -->
        <div class="modal fade" id="rejectModal<%= index %>" tabindex="-1" aria-labelledby="rejectModalLabel<%= index %>" aria-hidden="true">
          <div class="modal-dialog">
            <form method="POST" action="/admin/listings/<%= listing._id %>/reject" class="modal-content">
              <div class="modal-header">
                <h5 class="modal-title" id="rejectModalLabel<%= index %>">Reason for Rejection</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
              </div>
              <div class="modal-body">
                <textarea name="message" class="form-control" placeholder="Enter reason here..." required></textarea>
              </div>
              <div class="modal-footer">
                <button type="submit" class="btn btn-danger">Submit Rejection</button>
              </div>
            </form>
          </div>
        </div>

      <% }) %>
    </div>
  <% } %>
</div>


<!--History-->
<div id="history" class="content-section">
  <h3 class="mb-4">Approval History</h3>

  <% if (history.length === 0) { %>
    <div class="alert alert-info">No approval/rejection history found.</div>
  <% } else { %>
    <table class="table table-bordered table-striped">
      <thead class="table-light">
        <tr>
          <th>Title</th>
          <th>Status</th>
          <th>Admin Name</th>
          <th>Admin Email</th>
          <th>Date</th>
          <th>Action</th>
          <th>Action</th>
        </tr>
      </thead>
      <tbody>
        <% history.forEach((record, index) => { %>
          <tr>
            <td><%= record.listing?.title || 'N/A' %></td>
            <td>
              <% if (record.status === 'approved') { %>
                <span class="badge bg-success">Approved</span>
              <% } else { %>
                <span class="badge bg-danger">Rejected</span>
              <% } %>
            </td>
            <td><%= record.adminUsername || 'Unknown' %></td>
<td><%= record.adminEmail || 'N/A' %></td>
<td><%= record.date.toLocaleDateString("en-IN") %></td>

            <td>
              <button class="btn btn-outline-primary btn-sm" data-bs-toggle="modal" data-bs-target="#viewModal<%= index %>">
                View
              </button>
              </td>
              <!-- Delete Button -->
            <td> 
          <form method="POST" action="/admin/history/delete/<%= record._id %>" style="display:inline;">
  <button class="btn btn-danger btn-sm" onclick="return confirm('Are you sure?')">Delete</button>
</form>




            </td>
          </tr>
        <% }); %>
      </tbody>
    </table>

    <!-- Modals -->
    <% history.forEach((record, index) => { %>
      <div class="modal fade" id="viewModal<%= index %>" tabindex="-1" aria-labelledby="viewModalLabel<%= index %>" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header bg-dark text-white">
        <h5 class="modal-title" id="viewModalLabel<%= index %>">Property Details - <%= record.listing?.title || 'N/A' %></h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div class="row mb-2">
          <!-- Left Column -->
          <div class="col-md-6">
            <p><strong>Title:</strong> <%= record.listing?.title || 'N/A' %></p>
            <p><strong>Description:</strong> <%= record.listing?.description || 'N/A' %></p>
            <p><strong>Price:</strong> ₹<%= record.listing?.price || 'N/A' %></p>
            <p><strong>Location:</strong> <%= record.listing?.location || 'N/A' %></p>
            <p><strong>Country:</strong> <%= record.listing?.country || 'N/A' %></p>
            <p><strong>Category:</strong> <%= record.listing?.category || 'N/A' %></p>
            <p><strong>Facilities:</strong> 
              <% if (record.listing?.facilities && record.listing.facilities.length > 0) { %>
                <%= record.listing.facilities.join(", ") %>
              <% } else { %>
                N/A
              <% } %>
            </p>
            <p><strong>Image:</strong><br>
              <% if (record.listing?.image && record.listing.image.url) { %>
                <img src="<%= record.listing.image.url %>" alt="Property Image" style="width: 100px; height: auto;" />
              <% } else { %>
                No Image
              <% } %>
            </p>
          </div>

          <!-- Right Column -->
          <div class="col-md-6">
            <p><strong>Status:</strong> 
              <% if (record.status === 'approved') { %>
                <span class="badge bg-success">Approved</span>
              <% } else { %>
                <span class="badge bg-danger">Rejected</span>
              <% } %>
            </p>
            <p><strong>Rejected Reason:</strong> <%= record.listing?.rejectionMessage || 'N/A' %></p>
            <p><strong>Posted by:</strong> <%= record.listing?.owner?.username || 'Unknown' %></p>
            <p><strong>Reviewed By:</strong> <%= record.adminUsername || 'Unknown' %></p>
            <p><strong>Reviewed On:</strong> <%= record.date?.toLocaleDateString('en-IN') || 'N/A' %></p>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>

    <% }); %>
  <% } %>
</div>




      </main>
    </div>
  </div>

  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    document.addEventListener("DOMContentLoaded", () => {
      const links = document.querySelectorAll(".sidebar-link");
      links.forEach(link => {
        link.addEventListener("click", e => {
          e.preventDefault();
          links.forEach(l => l.classList.remove("active"));
          document.querySelectorAll(".content-section").forEach(sec => sec.classList.add("d-none"));
          link.classList.add("active");
          const target = link.getAttribute("data-target");
          document.getElementById(target).classList.remove("d-none");
        });
      });
    });

document.addEventListener("DOMContentLoaded", () => {
  const defaultTab = document.querySelector('[data-target="home"]');
  defaultTab.click();
});


(function () {
    'use strict';
    const forms = document.querySelectorAll('.needs-validation');
    Array.from(forms).forEach(form => {
      form.addEventListener('submit', function (e) {
        if (!form.checkValidity()) {
          e.preventDefault();
          e.stopPropagation();
        }
        form.classList.add('was-validated');
      }, false);
    });
  })();

  </script>




</body>
</html>
